# 抱石路線標註與匹配 POC

## 簡介/概述

本 POC 旨在驗證「透過標註照片上的岩點位置來識別和匹配抱石路線」的技術可行性。核心概念是將路線視為「點集合的空間配置」，使用者在照片上點擊標記岩點位置，系統即時搜尋資料庫中相似的路線配置。

這個 POC 的主要目標是驗證 **Modified Hausdorff Distance (MHD)** 演算法在實際使用情境下的匹配效果，特別是：
- 演算法對「漏點」（使用者少標了某些岩點）的容忍度
- 演算法對「多點」（使用者多標了不相關的點）的容忍度
- 不同拍攝角度/距離造成的縮放、平移差異處理

基於 [docs/research/2025-11-27-bouldering-video-route-matching.md](../../research/2025-11-27-bouldering-video-route-matching.md) 的研究發現。

## 目標

1. **驗證 MHD 演算法的匹配準確度**：確認同一條路線在不同照片、不同標註下能被正確匹配
2. **驗證使用者體驗流程**：確認「拍照 → 標記 → 搜尋 → 確認」的流程直覺且順暢
3. **建立可測試的資料收集環境**：能夠快速累積路線資料，用於後續演算法調校

## 使用者故事

### 故事 1：標註並搜尋路線
> 作為一個攀岩者，我想要拍下眼前的路線照片並標記岩點位置，以便找到資料庫中是否已有這條路線的紀錄。

### 故事 2：建立新路線
> 作為一個攀岩者，當我標註的路線在資料庫中找不到匹配時，我想要將它儲存為新路線，以便之後自己或其他人可以找到它。

### 故事 3：為路線新增更多照片
> 作為一個攀岩者，當我找到匹配的路線後，我想要將我目前的照片加入該路線，以便增加該路線的辨識資料。

### 故事 4：瀏覽已儲存的路線
> 作為一個使用者，我想要查看所有已儲存的路線清單，以便了解目前資料庫的內容並進行管理。

### 故事 5：刪除路線
> 作為一個使用者，我想要刪除錯誤建立的路線，以便保持資料庫的整潔。

## 功能需求

### FR-1：圖片輸入
- FR-1.1：使用者可以透過裝置相機拍攝照片
- FR-1.2：使用者可以從裝置相簿上傳照片
- FR-1.3：選擇的圖片顯示在畫面主要區域，供使用者進行標記

### FR-2：岩點標記
- FR-2.1：使用者可以點擊圖片上的任意位置來新增標記點
- FR-2.2：標記點以視覺化方式顯示在圖片上（例如圓點或標記符號）
- FR-2.3：使用者可以一鍵清除所有已標記的點
- FR-2.4：標記點的座標需正規化為 0-1 的相對座標（相對於圖片尺寸）

### FR-3：即時路線搜尋
- FR-3.1：每當使用者新增一個標記點，系統自動觸發搜尋
- FR-3.2：搜尋結果顯示為候選路線列表
- FR-3.3：每個候選路線顯示：縮圖（含標記點覆蓋）、相似度百分比、路線名稱
- FR-3.4：候選路線依相似度由高到低排序

### FR-4：檢視候選路線
- FR-4.1：點擊候選路線可查看大圖
- FR-4.2：大圖上覆蓋顯示該路線的標記點
- FR-4.3：顯示路線名稱

### FR-5：建立新路線
- FR-5.1：提供「建立新路線」的選項（當搜尋結果不符合時）
- FR-5.2：使用者輸入路線名稱
- FR-5.3：儲存當前圖片、標記點座標、路線名稱

### FR-6：為現有路線新增圖片
- FR-6.1：在檢視候選路線時，提供「加入此路線」按鈕
- FR-6.2：將當前照片和標記點加入該路線作為額外的辨識資料

### FR-7：路線管理
- FR-7.1：使用者可以查看所有已儲存的路線清單
- FR-7.2：路線清單顯示每條路線的縮圖和名稱
- FR-7.3：使用者可以刪除路線

### FR-8：資料儲存
- FR-8.1：所有資料儲存在瀏覽器本地（使用 OPFS）
- FR-8.2：路線資料（名稱、標記點座標）以 JSON 格式儲存
- FR-8.3：圖片檔案儲存在 OPFS 的特定目錄下
- FR-8.4：一條路線可以關聯多張圖片（每張圖片有各自的標記點）

## 非目標（超出範圍）

- **不做** 使用者帳號或登入功能
- **不做** 雲端同步或跨裝置資料共享
- **不做** Instagram hashtag 產生或跳轉功能
- **不做** 場館（gym）分類或篩選
- **不做** 路線顏色標記
- **不做** 效能優化（這是 POC，資料量小，暴力搜尋即可）
- **不做** 單一標記點的撤銷（只提供全部清除）
- **不做** 旋轉不變性處理（假設使用者大致正面拍攝）

## 設計考量

### 畫面配置建議

**主畫面（標記與搜尋）**
```
┌─────────────────────────────┐
│  [拍照] [上傳圖片]           │
├─────────────────────────────┤
│                             │
│      圖片顯示區域            │
│    （可點擊標記岩點）         │
│                             │
├─────────────────────────────┤
│  [清除所有標記]              │
├─────────────────────────────┤
│  搜尋結果：                  │
│  ┌─────┐ ┌─────┐ ┌─────┐   │
│  │縮圖 │ │縮圖 │ │縮圖 │   │
│  │95%  │ │87%  │ │76%  │   │
│  │名稱 │ │名稱 │ │名稱 │   │
│  └─────┘ └─────┘ └─────┘   │
├─────────────────────────────┤
│  [建立新路線]                │
├─────────────────────────────┤
│  [查看所有路線]              │
└─────────────────────────────┘
```

**路線詳情彈窗**
```
┌─────────────────────────────┐
│  路線名稱            [關閉]  │
├─────────────────────────────┤
│                             │
│      大圖（含標記點）        │
│                             │
├─────────────────────────────┤
│  [將我的照片加入此路線]       │
└─────────────────────────────┘
```

## 技術考量

### 匹配演算法
- 採用 Modified Hausdorff Distance (MHD) 作為核心匹配演算法
- 座標正規化：平移到重心、縮放到標準大小（RMS）
- 相似度計算：將距離轉換為百分比顯示

### 資料儲存架構
- 使用 Origin Private File System (OPFS) 儲存所有資料
- 路線索引以 JSON 檔案形式儲存
- 圖片以原始檔案形式儲存在 OPFS 目錄中

### 資料結構概念
```
routes.json:
{
  "routes": [
    {
      "id": "uuid",
      "name": "路線名稱",
      "images": [
        {
          "id": "uuid",
          "filename": "images/xxx.jpg",
          "points": [
            { "x": 0.25, "y": 0.33 },
            { "x": 0.45, "y": 0.56 },
            ...
          ],
          "normalizedPoints": [...] // 預計算的正規化座標
        }
      ],
      "createdAt": "ISO timestamp"
    }
  ]
}
```

## 驗收標準（高階）

1. **基本流程可運作**：使用者能完成「拍照/上傳 → 標記 → 搜尋 → 建立/加入路線」的完整流程
2. **匹配演算法有效**：同一路線的不同照片標註，能在搜尋結果中排名前列
3. **容錯能力**：漏標或多標 1-2 個點時，仍能找到正確的路線
4. **資料持久化**：關閉瀏覽器後重新開啟，之前儲存的路線仍然存在

## 開放問題

1. **相似度閾值**：多少百分比以上才算「可能匹配」？需要實測後決定
2. **搜尋結果數量**：顯示前幾名候選？建議先設為 5-10 個，可調整
3. **最少標記點數**：雖然規格上沒有限制，但實際上標記 1-2 個點可能無法有效匹配，是否需要提示使用者？

## 參考資料

- [室內抱石路線標註與匹配技術研究](../../research/2025-11-27-bouldering-video-route-matching.md)
