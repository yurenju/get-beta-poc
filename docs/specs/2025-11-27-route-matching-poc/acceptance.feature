# language: zh-TW
功能: 抱石路線標註與匹配
  作為 攀岩愛好者
  我想要 透過標註照片上的岩點來搜尋和管理路線
  以便 驗證 MHD 演算法的匹配效果

  背景:
    假設 使用者已開啟應用程式
    並且 瀏覽器支援 OPFS
    並且 測試圖片位於 docs/specs/2025-11-27-route-matching-poc/routes/ 目錄（route-1.png 到 route-4.png）

  # ===== 基本流程 =====

  場景: 上傳圖片並標記岩點
    假設 使用者在主畫面
    當 使用者點擊「上傳圖片」按鈕
    並且 選擇一張路線照片
    那麼 應該看到圖片顯示在主要區域
    當 使用者點擊圖片上的某個位置
    那麼 應該看到該位置出現一個標記點
    當 使用者再點擊另一個位置
    那麼 應該看到兩個標記點都顯示在圖片上

  場景: 清除所有標記點
    假設 使用者已上傳圖片並標記了 3 個點
    當 使用者點擊「清除所有標記」按鈕
    那麼 應該看到所有標記點都被移除
    並且 圖片仍然顯示

  # ===== 路線建立 =====

  場景: 建立新路線
    假設 使用者已上傳圖片並標記了至少 3 個點
    當 使用者點擊「建立新路線」按鈕
    那麼 應該看到建立路線的彈窗
    當 使用者輸入路線名稱「測試路線 A」
    並且 點擊確認按鈕
    那麼 應該看到成功訊息
    並且 彈窗關閉

  場景: 資料持久化驗證
    假設 使用者已建立一條名為「測試路線 A」的路線
    當 使用者重新整理頁面
    並且 點擊「查看所有路線」按鈕
    那麼 應該在路線清單中看到「測試路線 A」

  # ===== 搜尋與匹配 =====

  場景: 即時搜尋 - 標記時自動觸發
    假設 資料庫中已有至少一條路線
    並且 使用者已上傳新圖片
    當 使用者標記第一個點
    那麼 應該看到搜尋結果區域開始顯示候選路線
    當 使用者標記第二個點
    那麼 搜尋結果應該更新

  場景: 搜尋結果顯示格式
    假設 資料庫中已有路線
    並且 使用者已標記至少 3 個點
    那麼 每個搜尋結果應該顯示縮圖
    並且 每個搜尋結果應該顯示相似度百分比
    並且 每個搜尋結果應該顯示路線名稱
    並且 搜尋結果應該按相似度由高到低排序

  場景: 匹配演算法有效性 - 同一路線應排名靠前
    假設 使用者已建立一條路線並標記了 5 個點
    當 使用者上傳同一路線的另一張照片
    並且 標記相同的 5 個岩點位置（允許些微偏差）
    那麼 該路線應該出現在搜尋結果的前 3 名
    並且 相似度應該高於 70%

  場景: 容錯能力 - 漏標 1-2 個點仍可匹配
    假設 使用者已建立一條有 5 個標記點的路線
    當 使用者上傳相同路線照片
    並且 只標記其中 3-4 個點（漏標 1-2 個）
    那麼 該路線仍應出現在搜尋結果中
    並且 相似度應該高於 50%

  場景: 容錯能力 - 標記位置有偏差仍可匹配
    假設 使用者已建立一條有 5 個標記點的路線
    當 使用者上傳相同路線照片
    並且 標記相同的 5 個點但每個點位置都有輕微偏移（約 5-10% 的偏差）
    那麼 該路線仍應出現在搜尋結果的前 3 名
    並且 相似度應該高於 60%

  # ===== 檢視與加入路線 =====

  場景: 檢視候選路線詳情
    假設 搜尋結果中顯示至少一條候選路線
    當 使用者點擊某個候選路線卡片
    那麼 應該看到路線詳情彈窗
    並且 彈窗中應該顯示大圖
    並且 大圖上應該覆蓋顯示標記點
    並且 應該顯示路線名稱
    並且 應該有「將我的照片加入此路線」按鈕

  場景: 將照片加入現有路線
    假設 使用者正在檢視某條路線的詳情彈窗
    並且 使用者目前有已標記的圖片
    當 使用者點擊「將我的照片加入此路線」按鈕
    那麼 應該看到成功訊息
    並且 彈窗關閉
    當 使用者再次搜尋該路線
    並且 檢視該路線詳情
    那麼 該路線應該包含新加入的照片

  # ===== 路線管理 =====

  場景: 查看所有已儲存路線
    假設 資料庫中已有多條路線
    當 使用者點擊「查看所有路線」按鈕
    那麼 應該看到路線清單彈窗
    並且 清單中應該顯示所有已儲存的路線
    並且 每條路線應該顯示縮圖和名稱

  場景: 刪除路線
    假設 使用者正在查看路線清單
    並且 清單中有一條名為「要刪除的路線」的路線
    當 使用者點擊該路線的刪除按鈕
    那麼 應該看到確認提示
    當 使用者確認刪除
    那麼 該路線應該從清單中消失
    並且 重新整理頁面後該路線仍不存在

  # ===== 多圖片路線搜尋 =====

  場景: 多圖片路線的搜尋匹配
    假設 使用者已建立一條路線並加入了兩張不同標記的照片
    當 使用者上傳新照片並標記與第二張照片相似的點
    那麼 該路線應該出現在搜尋結果中
    並且 相似度應該反映與最匹配圖片的距離
