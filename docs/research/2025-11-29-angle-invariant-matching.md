# 不同拍攝角度下的路線匹配演算法研究

## 執行摘要

本研究針對攀岩路線匹配系統在不同拍攝角度下相似度偏低的問題進行深入分析。經過對 9 條路線、17 張照片的實測數據分析，以及多種演算法的實驗比較，我們找到了有效的改善方案。

關鍵發現：
- **原始演算法問題**：同路線相似度平均 68.6%，最低僅 29%（紅色 v4）
- **透視變形是主因**：寬高比差異超過 25% 的路線，相似度普遍低於 70%
- **組合演算法效果顯著**：採用 MHD + 順序感知匹配的組合方案，可將最低相似度從 29% 提升至 57-61%，同時維持良好的區分能力

**建議採用方案**：組合演算法（MHD 權重 0.6 + 順序匹配權重 0.4，maxDistance=0.6）

## 背景與脈絡

這個 POC 專案的核心目標是驗證「透過標記攀岩路線岩點位置來識別路線」的技術可行性。使用者從不同位置和角度拍攝同一面岩壁，然後標記岩點位置，系統需要能夠識別出這是同一條路線。

目前的演算法流程如下：
1. 將使用者標記的點集合進行正規化（平移到重心 + RMS 縮放）
2. 使用 Modified Hausdorff Distance 計算兩個正規化點集合的距離
3. 將距離轉換為 0-100% 的相似度百分比

問題的核心在於：**正規化演算法假設點集合只有平移和等比例縮放的變化**，但實際拍攝時會產生透視變形（perspective distortion），導致點集合發生非均勻的扭曲。

## 研究問題與發現過程

### 初始觀察

使用者報告：不同角度拍攝的照片雖然能找到正確的匹配路線，但相似度百分比偏低。這可能影響使用者體驗，並在資料庫擴大後可能導致誤判。

### 問題定義

經過實測數據分析，我們需要回答以下問題：
1. 目前演算法的實際表現如何？哪些案例表現好，哪些表現差？
2. 造成相似度降低的主要因素是什麼？
3. 有哪些可行的演算法改善方案？

## 技術分析：深入理解問題

### 4.1 實測數據分析

我們對匯出的測試資料集進行了完整分析，包含 9 條路線、17 張照片：

| 路線名稱 | 圖片數 | 同路線相似度 | 寬高比差異 |
|---------|-------|-------------|-----------|
| 綠色 v1 | 2 | 93% | 3.0% |
| 橘色 vb | 2 | 89% | 11.3% |
| 藍色 v1 | 2 | 80% | 16.9% |
| 水藍色 v1 | 2 | 73% | 29.6% |
| 紫色 v1 | 2 | 70% | 10.7% |
| 黑色 v2 | 2 | 62% | 13.3% |
| 綠色 v0 | 2 | 53% | 49.2% |
| 紅色 v4 | 2 | **29%** | 27.1% |

統計摘要：
- 同路線平均相似度：68.6%
- 跨路線平均相似度：15.1%
- 區分能力（差距）：53.5%

### 4.2 視覺分析：角度變化帶來的影響

透過實際查看照片，我們觀察到以下模式：

**表現最差案例：紅色 v4（29%）**

兩張照片的拍攝角度差異極大：
- 第一張：從左側斜上方拍攝，岩壁呈現左高右低的傾斜
- 第二張：從右側較正面拍攝，岩壁較為垂直

這導致：
- 寬高比差異 27.1%
- 點的相對位置產生明顯的透視扭曲
- 左右方向的壓縮/拉伸不均勻

**表現最佳案例：綠色 v1（93%）**

兩張照片的拍攝角度較為接近：
- 都是從較正面的角度拍攝
- 寬高比差異僅 3.0%
- 點的相對位置保持一致

**第二差案例：綠色 v0（53%）**

兩張照片：
- 第一張：較遠距離拍攝，包含更多岩壁範圍
- 第二張：較近距離拍攝，聚焦在路線本身

寬高比差異高達 49.2%，這是所有案例中最大的，直接反映了視角的巨大差異。

### 4.3 問題根源分析

目前演算法的局限性：

1. **僅處理相似變換（Similarity Transform）**
   - 目前的正規化只處理：平移 + 等比例縮放
   - 無法處理：旋轉、仿射變換、透視變換

2. **透視變形的特性**
   - 攀岩岩壁是近似平面，不同角度拍攝會產生 2D 單應性變換（Homography）
   - 單應性變換有 8 個自由度，遠超過相似變換的 4 個自由度
   - 這會導致：平行線不再平行、遠處物體看起來更小

3. **MHD 對形變的敏感性**
   - MHD 假設兩個點集合的幾何形狀相似
   - 透視變形會改變點之間的相對距離和角度
   - 即使是同一路線，變形後的 MHD 也會變大

## 實驗結果

我們實作了測試腳本 `scripts/test-algorithms.ts`，對多種演算法進行系統性比較。

### 5.1 maxDistance 參數調整實驗

測試不同 `maxDistance` 參數對相似度計算的影響：

| maxDistance | 同路線平均 | 同路線最低 | 跨路線平均 | 跨路線最高 | 區分差距 |
|-------------|-----------|-----------|-----------|-----------|---------|
| 0.4 | 60.8% | 11% | 5.5% | 42% | 55.3% |
| **0.5（原始）** | **68.6%** | **29%** | **15.1%** | **54%** | **53.5%** |
| 0.6 | 73.8% | 41% | 26.9% | 62% | 46.9% |
| 0.7 | 77.5% | 49% | 36.4% | 67% | 41.1% |
| 0.8 | 80.1% | 55% | 44.2% | 71% | 36.0% |
| 1.0 | 84.3% | 64% | 55.3% | 77% | 29.0% |

**發現**：
- 調高 maxDistance 可提升同路線相似度，但會犧牲區分能力
- maxDistance=0.6~0.7 是較好的平衡點
- 單純調參數無法根本解決問題（最低相似度仍偏低）

### 5.2 順序感知匹配演算法實驗

我們實作了兩種順序感知匹配方法：

**方法一：DTW 順序匹配**
- 將點按 Y 座標排序，提取 X 座標序列
- 使用 Dynamic Time Warping (DTW) 計算序列距離

**方法二：相對位置順序匹配**
- 將 X 座標正規化到 0-1 範圍
- 使用 DTW 比較正規化後的序列

| 演算法 | 同路線平均 | 同路線最低 | 跨路線平均 | 跨路線最高 | 區分差距 |
|--------|-----------|-----------|-----------|-----------|---------|
| DTW 順序匹配 | 78.4% | 56% | 73.3% | 89% | 5.1% ❌ |
| **相對位置順序匹配** | **92.3%** | **81%** | **72.9%** | **93%** | **19.3%** |

**發現**：
- 順序匹配大幅提升同路線相似度（紅色 v4 從 29% → 81%！）
- 但區分能力嚴重下降，單獨使用不可行
- 需要與 MHD 組合使用

### 5.3 組合演算法實驗

測試不同權重配置的組合演算法：

```
finalScore = mhdWeight * MHD_similarity + orderWeight * Order_similarity
```

| 權重配置 | 同路線平均 | 同路線最低 | 跨路線平均 | 跨路線最高 | 區分差距 |
|---------|-----------|-----------|-----------|-----------|---------|
| MHD=0.7, Order=0.3 | 79.3% | 53% | 40.8% | 70% | 38.5% |
| **MHD=0.6, Order=0.4** | **81.3%** | **57%** | **45.2%** | **73%** | **36.0%** |
| MHD=0.5, Order=0.5 | 83.0% | 61% | 50.2% | 76% | 32.8% |
| MHD=0.4, Order=0.6 | 84.8% | 65% | 54.6% | 79% | 30.2% |

### 5.4 其他演算法實驗

除了上述方案，我們也實作並測試了研究文獻中提到的其他演算法（測試腳本：`scripts/test-additional-algorithms.ts`）：

| 演算法 | 同路線平均 | 同路線最低 | 跨路線平均 | 區分差距 | 結論 |
|--------|-----------|-----------|-----------|---------|------|
| 拓撲結構匹配 | 67.3% | 38% | 11.2% | 56.0% | 區分好但最低仍差 |
| 仿射不變（三角形面積比）| 86.1% | 70% | 81.5% | 4.7% | 無區分能力 |
| MHD + 寬高比懲罰 | 68.0% | 29% | 14.4% | 53.6% | 幾乎無改善 |
| 角度分布特徵 | 90.3% | 75% | 76.6% | 13.7% | 無區分能力 |
| 距離比特徵 | 93.9% | 87% | 97.7% | -3.8% | 完全無區分 |
| 凸包形狀比較 | 97.4% | 86% | 86.7% | 10.7% | 無區分能力 |

**關鍵發現**：大多數「理論上應該有效」的特徵在這個場景下都失敗了。原因是攀岩路線具有特殊性：點數相近、垂直分布、形狀相似——這導致仿射不變、距離比、凸包等通用特徵無法有效區分不同路線。

### 5.5 實驗結論

**最佳方案比較表**：

| 演算法 | 同路線平均 | 同路線最低 | 區分差距 | 評估 |
|--------|-----------|-----------|---------|------|
| MHD (maxDist=0.5, 原始) | 68.6% | 29% | 53.5% | 區分好，但最低值太差 |
| MHD (maxDist=0.7) | 77.5% | 49% | 41.1% | 平衡但仍有改善空間 |
| 相對位置順序匹配 | 92.3% | 81% | 19.3% | 同路線好，但區分差 |
| **組合 (MHD=0.6, Order=0.4)** | **81.3%** | **57%** | **36.0%** | **✅ 最佳平衡** |

**建議採用**：組合演算法 (MHD=0.6, Order=0.4, maxDist=0.6)
- 同路線最低相似度從 29% 提升到 57%（提升 96%）
- 維持 36% 的區分差距（仍然良好）
- 在「提升最差案例」和「維持區分能力」之間取得最佳平衡

## 建議方案

基於實驗結果，建議採用**組合演算法（MHD + 順序感知匹配）**：

**配置參數**：
- MHD 權重：0.6
- 順序匹配權重：0.4
- maxDistance：0.6

**各路線改善效果**：

| 路線 | 原始 MHD | 組合演算法 | 改善幅度 |
|------|---------|-----------|---------|
| 橘色 vb | 89% | 93% | +4% |
| 水藍色 v1 | 73% | 85% | +12% |
| 藍色 v1 | 80% | 88% | +8% |
| 黑色 v2 | 62% | 76% | +14% |
| 紫色 v1 | 70% | 82% | +12% |
| **紅色 v4** | **29%** | **57%** | **+28%** |
| 綠色 v1 | 93% | 96% | +3% |
| 綠色 v0 | 53% | 73% | +20% |

**替代方案**（如不想修改演算法）：
1. **調整 maxDistance=0.7**：最低相似度從 29% → 49%，區分差距 41.1%
2. **鼓勵多圖儲存**：在 UI 提示使用者為路線新增多角度照片

## 測試腳本

本研究使用以下腳本進行實驗：

| 腳本 | 用途 |
|------|------|
| `scripts/analyze-matching.ts` | 初始資料分析，計算同路線/跨路線相似度統計 |
| `scripts/test-algorithms.ts` | 測試 maxDistance 參數調整、順序感知匹配、組合演算法 |
| `scripts/test-additional-algorithms.ts` | 測試其他演算法（拓撲、仿射不變、角度分布等） |

執行方式：
```bash
npx tsx scripts/analyze-matching.ts
npx tsx scripts/test-algorithms.ts
npx tsx scripts/test-additional-algorithms.ts
```

測試資料集位置：`docs/research/route-dataset-2025-11-29 (1)/`

## 下一步行動

1. **整合到 `src/lib/matching.ts`**：實作組合演算法
2. **執行測試驗證**：用 `scripts/test-algorithms.ts` 確認效果
3. **更新相關文件**：記錄演算法變更

## 參考資料

### 技術文件

- [Point-Set Registration - Wikipedia](https://en.wikipedia.org/wiki/Point-set_registration)
- [GitHub - Point Set Matching/Registration Material](https://github.com/gwang-cv/Point-Set-Matching-Registration-Material)

### 相關論文與方法

- [Feature Matching with SIFT, NNDR, and RANSAC](https://cameledge.com/post/computer-vision/feature-matching-and-ransac)
- [Affine versus Projective Transformation for Image Matching](https://ieeexplore.ieee.org/document/7412233/)
- [Shape-based Object Matching Using Interesting Points](https://www.sciencedirect.com/science/article/abs/pii/S0167865516000829)
- [Shape Context Descriptors](https://wang.ist.psu.edu/imagination/thayananthan.pdf)
- [Affine Invariant Relative Attitude Relationship Descriptor](https://asp-eurasipjournals.springeropen.com/articles/10.1186/1687-6180-2012-209)

### 延伸閱讀

- [MIT Lecture: Homographies and RANSAC](http://6.869.csail.mit.edu/fa12/lectures/lecture13ransac/lecture13ransac.pdf)
- [Fast and Interpretable 2D Homography Decomposition](https://arxiv.org/html/2402.18008v1)
